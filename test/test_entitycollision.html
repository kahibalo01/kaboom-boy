<!DOCTYPE html>
<html>
	<head>
		<title>Entity Collision Test</title>
		<link rel = "stylesheet" href = "../css/page_style.css"/>
		<script type = "text/javascript" src = "../js/Defines.js"></script>
		<script type = "text/javascript" src = "../js/engine/GameStateManager.js"></script>
		<script type = "text/javascript" src = "../js/engine/GameEngine.js"></script>
		<script type = "text/javascript" src = "../js/engine/InputHandler.js"></script>
		<script type = "text/javascript" src = "../js/engine/ResourceLoader.js"></script>
		<script type = "text/javascript" src = "../js/engine/Spritesheet.js"></script>
		<script type = "text/javascript" src = "../js/map/Tile.js"></script>
		<script type = "text/javascript" src = "../js/map/Map.js"></script>
		<script type = "text/javascript" src = "../js/TilemapCollisionComponent.js"></script>
		<script type = "text/javascript" src = "../js/Entity.js"></script>
		<script type = "text/javascript" src = "../js/Bomber.js"></script>



		<script>
			var Game = (function(Defines, GameEngine, GameStateManager, ImageLoader, KeyHandler, Map, Tile, Spritesheet, Bomber, TilemapCollisionComponent){

				function createMap(maparray){
					var i, j, 
						r = maparray.length, c = maparray[0].length,
						tiledata;

					var tilemap = [], row;

					for(i = 0; i < r; i++){
						row = [];
						for(j = 0; j < c; j++){
							tiledata = maparray[i][j];
							row.push(new Tile(tiledata[0], tiledata[1]));
						}
						tilemap.push(row);
					}

					return tilemap;
				}


				var mapdata = [
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [1, 1], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]],
					[[5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0], [5, 0]]
				];

				var ge, gsm, keyhandler, imageloader;

				var entityCollisionState = (function(){

					var ecs = {};
					

					ecs.init = function(){
						ecs.tileMap = new Map(createMap(mapdata), new Spritesheet(imageloader.getImage("maptest-image"), 20, 20), 640, 480);			
						ecs.tilemapCollisionComponent = new TilemapCollisionComponent(this.tileMap);

						ecs.bomber = new Bomber({
							x: 0,
							y: 0,
							w: 20,
							h: 20,
							speed: 1,
							inputhandler: keyhandler
						}, this.tileMap, this.tilemapCollisionComponent);
					}

					ecs.update = function(){
						this.bomber.update();
					}

					ecs.render = function(ctx){
						this.tileMap.render(ctx);
						ecs.bomber.render(ctx);
					}

					return ecs;

				})();

				ge = new GameEngine(30, 640, 480, 4);
				
				// Game States
				gsm = ge.getGameStateManager();
				gsm.addState("collision-test", entityCollisionState);

				// Images to load
				imageloader = new ImageLoader();
				imageloader.queueLoadImage("maptest-image", "../assets/img/test/Map Tiles Test.png");

				return function(){
					imageloader.loadAllImages(function(){},
						function(){
							ge.init(document.getElementById("game-container"));
							keyhandler = new KeyHandler(ge.getMainCanvas());
							gsm.loadState("collision-test", true);
							ge.run();
						}
					);
				}



			})(KaboomBoy.Defines, KaboomBoy.GameEngine, KaboomBoy.GameStateManager, 
			KaboomBoy.ImageLoader, KaboomBoy.KeyHandler, KaboomBoy.Map, KaboomBoy.Tile, KaboomBoy.Spritesheet, KaboomBoy.Bomber,
			KaboomBoy.TilemapCollisionComponent);
		
			window.onload = function(){
				Game();
			}
		</script>

	</head>
	<body>
		<div id = "game-container"></div>
		<div id = "description">

		</div>
	</body>
</html>